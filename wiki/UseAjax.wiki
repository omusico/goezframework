#summary 使用 Ajax

[TableOfContents 回目錄]

----

= 使用 Ajax =

雖然 !GoEz Framework 沒有提供 Ajax 自動化的機制，但它還是儘可能將幾個可以處理 Ajax 方式整合了進來。

== 判斷 request 是不是 Ajax ==

我們在 action 中用以下方法判斷目前的 Http Request 是不是以 Ajax 方式傳送的：

{{{
if ($this->_request->isAjax()) {
    // ... 處理
}
}}}

這個功能支援目前主流瀏覽器以 !XmlHttpRequest 丟給 PHP 的 Ajax Request 。

== 輸出 JSON ==

一般 Ajax 回傳常用 JSON 格式輸出，我們也可以在 action 中將 View 用 JSON 格式回傳。

範例：

{{{
$this->_view->abc = 123;
$this->_view->def = 456;
$this->_view->renderJson();

/*

輸出：
{"abc":123,"def":456}

*/
}}}

== 讓 Ajax 頁面在關閉 !JavaScript 時也能運作 ==

下面的範例示範了如何加入處理 AJAX 需求，以及關閉 !JavaScript 後，頁面還是能夠正常運行的方法：

{{{
public function testAction()
{
    $error = false;
    $message = '';

    // 透過 isPost 來讓 action 可以自己處理 POST 回來的資訊
    if ($this->_request->isPost()) {
        // ...處理 POST 資訊，有錯誤就設定 $error 及 $message

        $this->_view->error = $error;
        $this->_view->message = $message;
    }

    if ($this->_request->isAjax()) { // 如果是 AJAX 要求，就丟出 JSON
        $this->_view->renderJson();
    } else { // 否則還是輸出原頁面
        $this->_view->renderTemplate('test.tpl.htm');
    }
}
}}}

當然，前端的 HTML 一開始就要先完成不用 Ajax 的版本，然後再外加 Ajax 機制。

== 使用 FrontendVars 來取得 PHP 變數 ==

如果要讓某個樣版變數以 Smarty 輸出，而不要輸出為 JSON 格式時，可以用 View 的 setFrontendVars 方法來指定。

而 setFrontendVars 方法指定的變數，我們可以將它放在 Template 中，讓 !JavaScript 可以取它的內容：

{{{
// 在某 action 中
$this->_view->setFrontendVars('abc', 123);
$this->_view->setFrontendVars('def', 456);
$this->_view->renderTemplate('test.tpl.htm');
}}}

然後在 test.tpl.htm 裡，我們可以在 <head> 區段內加入：

{{{
<script type="text/javascript">
var $frontendVars = <% $frontendVars|@json_encode %>;
</script>
<script type="text/javascript" src="開發者自訂的 JavaScript 檔案"></script>
}}}

這樣一來，開發者自訂的 !JavaScript 就可以使用 $frontendVars.abc 及 $frontendVars.def 兩個變數了。

*而 $frontendVars.baseUrl 是 !GoEz Framework 預設提供的，不能更改。*

----

[TableOfContents 回目錄]